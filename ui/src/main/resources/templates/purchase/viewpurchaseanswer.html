<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragment/header :: header"/>
<body>
	<div class="wrapper">
		<header th:replace="fragment/navbar :: navbar-header" />
		<aside th:replace="fragment/navbar :: navbar-aside (page = 'purchases')" />
 
		<section>
			<div class="content-wrapper">
				<div class="panel panel-default">
					<div class="panel-heading"></div>
					<div class="panel-body">
						<div class="row">
							<div class="col-lg-12">
								<h3 th:text="#{html.answer.view.answerfrom} + ' ' + ${purchaseAnswer.vendorOrganization.domain}" />
							</div>
						</div>
	
						<div class="row">
							<div class="col-lg-12">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.purchase.itsystem}" />
									<div class="col-sm-10">
										<span th:text="${purchaseAnswer.itSystem}!=null ? (${purchaseAnswer.itSystem.name}+' ('+${purchaseAnswer.itSystem.vendor}+')') : #{html.vendor.itsystem.notset}" />
									</div>
								</div>
							</div>
	
							<div class="col-lg-12" th:if="${purchaseAnswer.itSystem} != null">
								<div class="form-group">
									<label class="col-sm-2 control-label" th:text="#{html.kitos.url}" />
									<div class="col-sm-10">
										<a target="_blank" th:href="${@environment.getProperty('kitos.base.url')}+${purchaseAnswer.itSystem.systemId} + '/main'" th:text="${@environment.getProperty('kitos.base.url')}+${purchaseAnswer.itSystem.systemId} + '/main'"></a>
										<span th:text="#{html.control.a.open.new.tab}"></span>
									</div>
								</div>
							</div>
						</div>
							
						<div class="row" style="margin-bottom: 20px; margin-right: 0px;">
							<button id="vendorSendBtn" onclick="vendorService.showRequestVendorAnswerModal();" class="btn btn-primary" style="float: right;">
								<span th:text="#{html.purchase.answer.vendor.send.btn}"/>
							</button>
						</div>
	
						<div class="row">
							<div class="col-lg-12">
								<div class="table-responsive">
									<table class="listTable table table-striped table-hover">
										<thead>
											<tr>
												<th class="col-md-2" th:text="#{html.answer.requirement}" />
												<th class="col-md-3" th:text="#{html.answer.description}" />
												<th class="col-md-1" th:text="#{html.answer.category}" />
												<th class="col-md-1" th:text="#{html.answer.priority}" th:if="${showPriority}" />
												<th th:class="${showPriority} ? 'col-md-1' : 'col-md-2'" th:text="#{html.answer.answer}" />
												<th th:if="${showPrice}" class="col-md-1" th:text="#{html.answer.price}" />
												<th th:class="${showPrice} ? 'col-md-2' : 'col-md-3'" th:text="#{html.answer.answerdetail}" />
												<th class="col-md-1" th:text="#{html.header.operation}" />
											</tr>
										</thead>
	
										<tbody>
											<tr th:each="purchaseRequirementAnswer : ${purchaseAnswer.purchaseRequirementAnswers}">
												<td>
												<span th:text="${purchaseRequirementAnswer.requirement.name}"></span>
												<span style="margin-bottom: 0px !important;">
													<a th:if="${@purchaseRequirementService.hasHelpText(purchaseRequirementAnswer.requirement)}" href="#" rel="popover" data-html="true" data-placement="right" data-toggle="popover" data-trigger="hover" th:title="#{pdf.purchase.view.helpText}" th:attr="data-content='<pre>'+${@purchaseRequirementService.getHelpText(purchaseRequirementAnswer.requirement)}+'</pre>'" onclick="return false;">
														<em class="fa fa-lg fa-question-circle"></em>
													</a>
												</span>
												</td>
												<td class="preformat" th:text="${purchaseRequirementAnswer.requirement.description}" />
												<td th:text="${purchaseRequirementAnswer.requirement.category.name}" />
												<td th:if="${showPriority}" th:text="#{__${purchaseRequirementAnswer.requirement.importance.value}__}" />
												<th:block th:if="${purchaseRequirementAnswer.choice} == null">
													<td/>
												</th:block>
												<th:block th:if="${purchaseRequirementAnswer.choice} != null">
													<td>
														<div th:text="#{__${purchaseRequirementAnswer.choice.displayName}__}"/>
														<th:block th:if="${purchaseRequirementAnswer.customerAnswer != null && purchaseRequirementAnswer.customerAnswer.toString() != 'NONE'}">
															<span class="badge" th:classappend="${purchaseRequirementAnswer.customerAnswer.toString() == 'REJECTED'} ? 'badge-fail': (${purchaseRequirementAnswer.customerAnswer.toString() == 'ELABORATION_NEEDED'} ? 'badge-maybe' : '')" th:text="#{__${purchaseRequirementAnswer.customerAnswer.value}__}"/>
														</th:block>
													</td>
												</th:block>
												<td th:if="${showPrice}" th:text="${purchaseRequirementAnswer.price}" />
												<td class="preformat" th:text="${purchaseRequirementAnswer.detail}" />
												<td>
													<em th:onclick="'javascript:modalService.open(' + ${purchaseRequirementAnswer.id} + ')'" class="fa fa-fw fa-pencil" th:title="#{html.mouseover.purchaseanswer.answer}"></em>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
	
	<div id="requestAnswersFromVendorModal" class="modal fade" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title" th:text="#{html.purchase.page.requestvendor.title}" />
				</div>
	
				<form class="form-horizontal" id="requestAnswersFromVendorForm">
					<div class="modal-body">
						<div class="form-group">
							<label class="col-sm-2 control-label" th:text="#{html.purchase.page.requestvendor.message}" />
							<div class="col-sm-10">
								<textarea rows="8" id="requestAnswersFromVendorFormMessage" class="form-control"></textarea>
							</div>
						</div>
					</div>

					<div class="modal-footer">
						<button type="submit" id="requestAnswersFromVendorButton" class="btn btn-primary" th:text="#{html.control.button.send.request}" />
						<button type="button" class="btn btn-danger" data-dismiss="modal" th:text="#{html.control.button.close}"/>
					</div>
				</form>
			</div>
		</div>
	</div>
	
	<div id="answerModalPlaceholder"></div>

	<style>
		div.popover-content > pre {
			display: block;
			padding: 10px;
			margin: 0 0 10.5px;
			font-size: 14px;
			font-family: inherit;
			line-height: 21.4px;
			word-break: break-all;
			color: #656565 !important;
			background-color: transparent;
			border: 0;
			border-radius: 0px;
			
			white-space: -moz-pre-wrap; /* Mozilla, supported since 1999 */
			white-space: -pre-wrap; /* Opera */
			white-space: -o-pre-wrap; /* Opera */
			white-space: pre-wrap; /* CSS3 - Text module (Candidate Recommendation) http://www.w3.org/TR/css3-text/#white-space */
			word-wrap: break-word; /* IE 5.5+ */
		}
	</style>
	
	<div th:replace="fragment/footer :: footer" />

	<script th:replace="fragment/datatables :: datatables " />
	
	<script th:inline="javascript">
		/*<![CDATA[*/

		/*[+
			var baseUrl = [[@{/}]];
			var vendorMustElaborate = [[${purchaseAnswer.vendorMustElaborate}]];
			var fieldNotUpdatedMsg = [[#{html.purchase.failedupdate}]];
			var mailsentmsg = [[#{html.purchase.answer.vendor.send.success}]];
			var purchaseId = [[${purchaseAnswer.id}]];
		+]*/
		
		var token = $("meta[name='_csrf']").attr("content");
		var modalService, vendorService;
		$(document).ready(function(){
			modalService = new ModalService();
			vendorService = new VendorService();
			
			if (vendorMustElaborate) {
				$("#vendorSendBtn").prop("disabled",true);
			}
			
			$("#requestAnswersFromVendorButton").on('click', function() {
				vendorService.send();
				return false;
			});
        });

		function ModalService() {
			this.open = function(id) {
				$("#answerModalPlaceholder").load(baseUrl + "purchase/fragments/answermodal/" + id, function(){
					var selected = $("#status option:selected").val();
					if (selected == "ACCEPTED_WITH_COMMENT" || selected == "ELABORATION_NEEDED") {
						$("#hideModalComment").show();
					}
					$("#answerModal").modal('show');
				});
			}
			
			this.selectListener = function(selectedIndex) {
				if (selectedIndex == 2 || selectedIndex == 4) {
					$("#hideModalComment").show();
				} else {
					$("#hideModalComment").hide();
				}
			}
			
			this.save = function(id) {
				var selected = $("#status option:selected").val();
				var comment = $("#modalComment").val();
				
				$.ajax({
					url : baseUrl + 'rest/purchase/purchaserequirementanswer/'+ id + '/comment',
					type : 'post',
					contentType: 'application/json',
					headers: {
						'X-CSRF-TOKEN': token
					},
					data : JSON.stringify({
						status: selected,
						comment: comment
					}),
					success: function() {
						location.reload(true);
					}
				});
				
				$("#modalComment").val("");
				$("#status option:first");
				$("#answerModal").modal('hide');
			}
		}
		
		function VendorService() {
			this.showRequestVendorAnswerModal = function() {
				$('#requestAnswersFromVendorModal').modal()
			};

			this.send = function() {
				$("#requestAnswersFromVendorModal").modal('hide');

				$.ajax({
					url : baseUrl + 'rest/purchase/purchaseanswer/'+ purchaseId + '/vendor/send',
					type : 'POST',
					headers: {
						'X-CSRF-TOKEN': token,
						'content-type': 'text/plain'
					},
					data: $('#requestAnswersFromVendorFormMessage').val(),
					success : function(data) {
						$.notify(mailsentmsg, {
							status : 'success',
							pos : 'top-right'
						});

						$("#vendorSendBtn").prop("disabled",true);
					},
					error : function(response) {
						$.notify(fieldNotUpdatedMsg, {
							status : 'danger',
							pos : 'top-right'
						});
					},
				});
			}
		}

		/*]]>*/
	</script>
</body>
</html>
